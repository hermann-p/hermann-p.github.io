<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Keyboard Mercenary</title>
  <meta name="theme-color" content="#222222" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="/js/jquery.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/header.js"></script>
  <script src="/js/toc.js"></script>
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/theme.css" rel="stylesheet">
  <link href="/css/syntax.css" rel="stylesheet">
  <link href="/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
</head>

<body>

  

  


 <script type="text/javascript">
  WebFontConfig = {
    google: {
      families: ['Ubuntu::latin']
    }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="/">Keyboard Mercenary</a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="/">/home</a></li>
          <li><a href="/archive.html">/archive</a></li>
          <li><a href="/tags.html">/tags</a></li>
          <li><a href="/about.html">/about</a></li>
        </ul>
      </div>
    </div>
  </nav>


<div class="wrapper">
  <div class="content">
    <div class="container container-center">
      <div class="row">
        <div class="col-md-8">
          <div class="article">
            <div class="well">
              <h1><a href="/2016/06/functional-games-1_5">Functional game programming with core.async part 1.5</a></h1>
              <div class="post-meta">
                <div class="post-time">
                  <i class="fa fa-calendar"></i>
                  <time>07 Jun 2016</time>
                </div>
                <ul>
                  
                    <li><a href="/tag/games">games</a></li>
                  
                    <li><a href="/tag/functional">functional</a></li>
                  
                    <li><a href="/tag/async">async</a></li>
                  
                </ul>
              </div>
              <div class="post-content">
                <div id="toc" class="toc"></div>
                <h1 id="bringing-some-live-to-the-game">Bringing some live to the game</h1>

<p>As the game loop in the first part of this series is a little boring, without
anything happening then drawing empty <code class="highlighter-rouge">update</code> and <code class="highlighter-rouge">draw</code> routines,
I’ll bring and discuss a couple of lines of code to flesh the introduction out.</p>

<p>In the end we will have balls dropping at regular intervals and a draggable foot
to kick them around. Europe is preparing for the soccer championship, after all…</p>

<p>I will bring the source code in order of interest, most “boring” mechanic parts
further down, so copy-pasting without thinking won’t work. You may, however,
get the working code from the folder “kicker” in
<a href="https://github.com/hermann-p/pet-projects">my pet project repo</a>.</p>

<iframe src="https://waechtertroll.lima-city.de/kicker-1.5/" width="100%"></iframe>

<p><a href="https://waechtertroll.lima-city.de/kicker-1.5/">Full screen</a></p>

<h2 id="event-handling">Event handling</h2>

<p>Now, all those events fired at our main loop need to be handled.</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="k">defmulti</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="nb">first</span><span class="p">)</span><span class="w"> </span><span class="c1">;; dispatch an event based on first vector element to proper function
</span><span class="w">
</span><span class="p">(</span><span class="k">defmethod</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="no">:drag</span><span class="w"> </span><span class="c1">;; handler for [:drag x y] event
</span><span class="w">  </span><span class="p">[[</span><span class="n">_</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="n">game</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[[</span><span class="n">nx</span><span class="w"> </span><span class="n">ny</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nf">to-game</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">game</span><span class="p">)]</span><span class="w">  </span><span class="c1">;; calculate game coordinates from window coords
</span><span class="w">    </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="no">:foot</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="p">(</span><span class="no">:foot</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="no">:x</span><span class="w"> </span><span class="n">nx</span><span class="w"> </span><span class="no">:y</span><span class="w"> </span><span class="n">ny</span><span class="p">))))</span><span class="w"> </span><span class="c1">;; update foot position
</span><span class="w">
</span><span class="p">(</span><span class="k">defmethod</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="no">:add-ball</span><span class="w"> </span><span class="c1">;; when a new ball is requested, spawn it
</span><span class="w">  </span><span class="c1">;; spawn a new ball at random position
</span><span class="w">  </span><span class="p">[</span><span class="n">v</span><span class="w"> </span><span class="n">game</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="no">:balls</span><span class="w"> </span><span class="nb">conj</span><span class="w"> </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="p">(</span><span class="nb">rand</span><span class="w"> </span><span class="p">(</span><span class="no">:x-tiles</span><span class="w"> </span><span class="n">game</span><span class="p">))</span><span class="w">
                            </span><span class="no">:y</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="c1">;; drop from above, don't just appear
</span><span class="w">                            </span><span class="no">:vx</span><span class="w"> </span><span class="mi">0</span><span class="w">
                            </span><span class="no">:vy</span><span class="w"> </span><span class="mi">0</span><span class="p">}))</span><span class="w">

</span><span class="c1">;; -------------------
;; Some functions to allow for dragging on desktop devices
</span><span class="p">(</span><span class="k">defmethod</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="no">:startdrag</span><span class="w"> </span><span class="p">[[</span><span class="n">_</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="n">game</span><span class="p">]</span><span class="w"> </span><span class="c1">;; to be called on mousedown
</span><span class="w">  </span><span class="p">(</span><span class="nf">action</span><span class="w"> </span><span class="p">[</span><span class="no">:drag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="no">:dragging</span><span class="w"> </span><span class="n">true</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">defmethod</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="no">:enddrag</span><span class="w"> </span><span class="p">[</span><span class="n">_</span><span class="w"> </span><span class="n">game</span><span class="p">]</span><span class="w"> </span><span class="c1">;; to be called on mouseup
</span><span class="w">  </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="no">:dragging</span><span class="w"> </span><span class="n">false</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">defmethod</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="no">:move</span><span class="w"> </span><span class="p">[[</span><span class="n">_</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="n">game</span><span class="p">]</span><span class="w"> </span><span class="c1">;; to be called on mouse move
</span><span class="w">  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="no">:dragging</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">action</span><span class="w"> </span><span class="p">[</span><span class="no">:drag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="c1">;; if we're dragging, return a call to the drag event
</span><span class="w">    </span><span class="n">game</span><span class="p">))</span><span class="w">                    </span><span class="c1">;; else return unchanged game state
</span></code></pre>
</div>

<p>Now our main loop’s call to (recur (action value world)) processes any received
events and then starts listening for the next one with updated state.</p>

<h2 id="updating-to-next-frame">Updating to next frame</h2>

<p>When a new frame is requested, the game state needs an update. This is done by
the <code class="highlighter-rouge">time-tick</code> function.</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">time-tick</span><span class="w">
  </span><span class="p">[</span><span class="n">game</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">zero?</span><span class="w"> </span><span class="p">(</span><span class="nf">mod</span><span class="w"> </span><span class="p">(</span><span class="no">:time</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="no">:spawn-every</span><span class="w"> </span><span class="n">game</span><span class="p">)))</span><span class="w"> </span><span class="c1">;; is it time to spawn a ball?
</span><span class="w">    </span><span class="p">(</span><span class="nf">go</span><span class="w"> </span><span class="p">(</span><span class="nf">&gt;!</span><span class="w"> </span><span class="n">action-channel</span><span class="w"> </span><span class="p">[</span><span class="no">:add-ball</span><span class="p">])))</span><span class="w">            </span><span class="c1">;; if so, send an event
</span><span class="w">  </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="no">:time</span><span class="w"> </span><span class="nb">inc</span><span class="p">)</span><span class="w"> </span><span class="c1">;; increase the game frame counter
</span><span class="w">      </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="no">:balls</span><span class="w">           </span><span class="c1">;; update all balls
</span><span class="w">             </span><span class="p">(</span><span class="nb">filter</span><span class="w"> </span><span class="p">(</span><span class="nb">partial</span><span class="w"> </span><span class="n">on-screen?</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="c1">;; remove balls that dropped or were kicked out of th screen
</span><span class="w">                     </span><span class="p">(</span><span class="nb">map</span><span class="w">          </span><span class="c1">; chain: gravity + detect collision + move
</span><span class="w">                      </span><span class="p">(</span><span class="nb">comp</span><span class="w"> </span><span class="p">(</span><span class="nb">partial</span><span class="w"> </span><span class="n">collision</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="n">update-pos</span><span class="w"> </span><span class="n">apply-gravity</span><span class="p">)</span><span class="w">
                      </span><span class="p">(</span><span class="no">:balls</span><span class="w"> </span><span class="n">game</span><span class="p">))))))</span><span class="w">
</span></code></pre>
</div>

<p>The game state updated takes all existing ball entities, calculates the influence
of gravity, a possible collision with the foot, and position and status
in the next frame for each one individually. If we were targetting Clojure
instead of ClojureScript, we could use <code class="highlighter-rouge">pmap</code> instead of <code class="highlighter-rouge">map</code> to
make use of multicore CPUs for large numbers of entities without having to care
for any race conditions, as we’re using pure functions.</p>

<h2 id="drawing-to-screen">Drawing to screen</h2>

<p>Playing an invisible game is quite boring (except Tetris master bonus level, of
course), so we will draw our entities. In our very first iteration of the game
we’ll use the html-canvas, fill it with background color and draw primitives
for entities: white circles for balls and a black circle for the foot.</p>

<p>Remember that you should use integer position coordinates when dealing with
the canvas whenever possible, to get significantly better performance.</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">draw</span><span class="w">
  </span><span class="p">[{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">s</span><span class="w"> </span><span class="n">x-tiles</span><span class="w"> </span><span class="n">y-tiles</span><span class="w"> </span><span class="n">foot</span><span class="w"> </span><span class="n">balls</span><span class="p">]</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">game</span><span class="p">}]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">ctx</span><span class="w"> </span><span class="p">(</span><span class="nf">.getContext</span><span class="w"> </span><span class="p">(</span><span class="nf">dommy/sel1</span><span class="w"> </span><span class="no">:canvas</span><span class="p">)</span><span class="w"> </span><span class="s">"2d"</span><span class="p">)</span><span class="w">
        </span><span class="p">[</span><span class="n">foot-x</span><span class="w"> </span><span class="n">foot-y</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nf">to-screen</span><span class="w"> </span><span class="p">(</span><span class="no">:x</span><span class="w"> </span><span class="n">foot</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="no">:y</span><span class="w"> </span><span class="n">foot</span><span class="p">)</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w">
        </span><span class="n">ball-size</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="no">:ball-size</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w">
        </span><span class="n">foot-size</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="no">:foot-size</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">)]</span><span class="w">
    </span><span class="c1">;; paint the background by filling a screen sized rectangle
</span><span class="w">    </span><span class="p">(</span><span class="nf">set!</span><span class="w"> </span><span class="p">(</span><span class="nf">.-fillStyle</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="s">"#AAAAFF"</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">.fillRect</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nf">.-innerWidth</span><span class="w"> </span><span class="n">js/window</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">.-innerHeight</span><span class="w"> </span><span class="n">js/window</span><span class="p">))</span><span class="w">
    
    </span><span class="c1">;; draw a black circle as foot
</span><span class="w">    </span><span class="p">(</span><span class="nf">set!</span><span class="w"> </span><span class="p">(</span><span class="nf">.-fillStyle</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="s">"#000000"</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nb">doto</span><span class="w"> </span><span class="n">ctx</span><span class="w">
      </span><span class="p">(</span><span class="nf">.beginPath</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nf">.arc</span><span class="w"> </span><span class="p">(</span><span class="nb">int</span><span class="w"> </span><span class="n">foot-x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">int</span><span class="w"> </span><span class="n">foot-y</span><span class="p">)</span><span class="w"> </span><span class="c1">;; center
</span><span class="w">            </span><span class="n">foot-size</span><span class="w">                 </span><span class="c1">;; radius
</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">Math/PI</span><span class="p">))</span><span class="w">          </span><span class="c1">;; from 0 to full circle
</span><span class="w">      </span><span class="p">(</span><span class="nf">.fill</span><span class="p">))</span><span class="w">
    
    </span><span class="c1">;; draw whit circles as balls
</span><span class="w">    </span><span class="p">(</span><span class="nf">set!</span><span class="w"> </span><span class="p">(</span><span class="nf">.-fillStyle</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="s">"#FFFFFF"</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">ball</span><span class="w"> </span><span class="n">balls</span><span class="p">]</span><span class="w"> </span><span class="c1">;; our filtered balls are a lazy sequence, so we can't just map the drawing over them
</span><span class="w">      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[[</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nf">to-screen</span><span class="w"> </span><span class="p">(</span><span class="no">:x</span><span class="w"> </span><span class="n">ball</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="no">:y</span><span class="w"> </span><span class="n">ball</span><span class="p">)</span><span class="w"> </span><span class="n">game</span><span class="p">)]</span><span class="w">
        </span><span class="p">(</span><span class="nb">doto</span><span class="w"> </span><span class="n">ctx</span><span class="w">
          </span><span class="p">(</span><span class="nf">.beginPath</span><span class="p">)</span><span class="w">
          </span><span class="p">(</span><span class="nf">.arc</span><span class="w"> </span><span class="p">(</span><span class="nb">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">int</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">ball-size</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">Math/PI</span><span class="p">))</span><span class="w">
          </span><span class="p">(</span><span class="nf">.fill</span><span class="p">))))))</span><span class="w">
</span></code></pre>
</div>

<p>This will be fine if you’re using fast graphics drivers and Chromium, but if 
you’re running with slow drivers on FireFox like me, you’ll see that there must
be faster ways to render our entities. We’ll explore DOM-based rendering later
in these articles.</p>

<h2 id="full-code-listing">Full code listing</h2>

<p>I won’t walk you through all that maths and physics stuff, because it’s really
simple at this point. After each time frame, gravity increases the y-down speed
a bit, and x- and y- speeds modify the position a little.
When the distance between the ball and our (round) player foot becomes less than
the sum of their radi, the ball is kicked away from the center of the foot.
Then there’s clipping to the game world (0 to x-tiles on x-axis, 0 to y-tiles
on y-axis); the <code class="highlighter-rouge">on-screen?</code> predicate just determines if the center of a
given ball is inside these boundaries.</p>

<p>Ok, that’s a lie - collission and screen checks are a bit finer, but nothing
important.</p>

<p>The complete game at this point, with all boring-but-needed maths and physics
stuff looks as follows:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="c1">;; =====
;; FILE core.cljs
;; =====
</span><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">kicker.core</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">dommy.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">dommy</span><span class="p">]</span><span class="w">
            </span><span class="p">[</span><span class="n">hipo.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">hipo</span><span class="p">]</span><span class="w">
            </span><span class="p">[</span><span class="n">cljs.core.async</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">chan</span><span class="w"> </span><span class="n">&gt;!</span><span class="w"> </span><span class="n">&lt;!</span><span class="p">]]</span><span class="w">
            </span><span class="p">[</span><span class="n">kicker.game</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">game</span><span class="p">])</span><span class="w">
  </span><span class="p">(</span><span class="no">:require-macros</span><span class="w"> </span><span class="p">[</span><span class="n">cljs.core.async.macros</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">go</span><span class="w"> </span><span class="n">go-loop</span><span class="w"> </span><span class="n">alt!</span><span class="p">]]))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">mouse-channel</span><span class="w"> </span><span class="p">(</span><span class="nf">as/chan</span><span class="w"> </span><span class="mi">10</span><span class="p">))</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">time-channel</span><span class="w"> </span><span class="p">(</span><span class="nf">as/chan</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">state-channel</span><span class="w"> </span><span class="n">game/state-channel</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">action-channel</span><span class="w"> </span><span class="n">game/action-channel</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="nf">.getTime</span><span class="w"> </span><span class="p">(</span><span class="nf">js/Date.</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">resize</span><span class="w">
  </span><span class="s">"Recalculate display scaling"</span><span class="w">
  </span><span class="p">[{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">x-tiles</span><span class="w"> </span><span class="n">y-tiles</span><span class="p">]</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">game</span><span class="p">}]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">width</span><span class="w"> </span><span class="p">(</span><span class="nf">.-innerWidth</span><span class="w"> </span><span class="n">js/window</span><span class="p">)</span><span class="w">
        </span><span class="n">height</span><span class="w"> </span><span class="p">(</span><span class="nf">.-innerHeight</span><span class="w"> </span><span class="n">js/window</span><span class="p">)</span><span class="w">
        </span><span class="n">scale</span><span class="w"> </span><span class="p">(</span><span class="nb">min</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="n">x-tiles</span><span class="p">)</span><span class="w">
                   </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="n">y-tiles</span><span class="p">))]</span><span class="w">
    </span><span class="p">(</span><span class="nf">.log</span><span class="w"> </span><span class="n">js/console</span><span class="w"> </span><span class="s">"Scaling to:"</span><span class="w"> </span><span class="n">scale</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">dommy/set-attr!</span><span class="w"> </span><span class="p">(</span><span class="nf">dommy/sel1</span><span class="w"> </span><span class="no">:canvas</span><span class="p">)</span><span class="w"> </span><span class="no">:width</span><span class="w"> </span><span class="n">width</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">dommy/set-attr!</span><span class="w"> </span><span class="p">(</span><span class="nf">dommy/sel1</span><span class="w"> </span><span class="no">:canvas</span><span class="p">)</span><span class="w"> </span><span class="no">:height</span><span class="w"> </span><span class="n">height</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="no">:s</span><span class="w"> </span><span class="n">scale</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">init</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="s">"Create canvas"</span><span class="w">
  </span><span class="p">(</span><span class="nf">dommy/append!</span><span class="w"> </span><span class="p">(</span><span class="nf">dommy/sel1</span><span class="w"> </span><span class="no">:body</span><span class="p">)</span><span class="w">
                 </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w">
                  </span><span class="p">(</span><span class="nf">hipo/create</span><span class="w"> </span><span class="p">[</span><span class="no">:canvas</span><span class="w"> </span><span class="s">"Update your browser. Really!"</span><span class="p">])</span><span class="w">
                  </span><span class="p">(</span><span class="nf">dommy/set-style!</span><span class="w"> </span><span class="no">:position</span><span class="w"> </span><span class="s">"fixed"</span><span class="w">
                                    </span><span class="no">:top</span><span class="w"> </span><span class="s">"0"</span><span class="w">
                                    </span><span class="no">:left</span><span class="w"> </span><span class="s">"0"</span><span class="w">
                                    </span><span class="no">:background-color</span><span class="w"> </span><span class="s">"blue"</span><span class="p">)))</span><span class="w">
  </span><span class="s">"Register event listeners"</span><span class="w">
  </span><span class="p">(</span><span class="nf">dommy/listen!</span><span class="w"> </span><span class="p">(</span><span class="nf">dommy/sel1</span><span class="w"> </span><span class="no">:canvas</span><span class="p">)</span><span class="w"> </span><span class="no">:touchmove</span><span class="w">
                 </span><span class="o">#</span><span class="p">(</span><span class="nf">go</span><span class="w"> </span><span class="p">(</span><span class="nf">&gt;!</span><span class="w"> </span><span class="n">mouse-channel</span><span class="w"> </span><span class="p">[</span><span class="no">:drag</span><span class="w"> </span><span class="p">(</span><span class="nf">.-clientX</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">.-clientY</span><span class="w"> </span><span class="n">%</span><span class="p">)])))</span><span class="w">
  </span><span class="p">(</span><span class="nf">dommy/listen!</span><span class="w"> </span><span class="p">(</span><span class="nf">dommy/sel1</span><span class="w"> </span><span class="no">:canvas</span><span class="p">)</span><span class="w"> </span><span class="no">:mousedown</span><span class="w">
                 </span><span class="o">#</span><span class="p">(</span><span class="nf">go</span><span class="w"> </span><span class="p">(</span><span class="nf">&gt;!</span><span class="w"> </span><span class="n">mouse-channel</span><span class="w"> </span><span class="p">[</span><span class="no">:startdrag</span><span class="w"> </span><span class="p">(</span><span class="nf">.-clientX</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">.-clientY</span><span class="w"> </span><span class="n">%</span><span class="p">)])))</span><span class="w">
  </span><span class="p">(</span><span class="nf">dommy/listen!</span><span class="w"> </span><span class="p">(</span><span class="nf">dommy/sel1</span><span class="w"> </span><span class="no">:canvas</span><span class="p">)</span><span class="w"> </span><span class="no">:mouseup</span><span class="w">
                 </span><span class="o">#</span><span class="p">(</span><span class="nf">go</span><span class="w"> </span><span class="p">(</span><span class="nf">&gt;!</span><span class="w"> </span><span class="n">mouse-channel</span><span class="w"> </span><span class="p">[</span><span class="no">:enddrag</span><span class="w"> </span><span class="p">(</span><span class="nf">.-clientX</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">.-clientY</span><span class="w"> </span><span class="n">%</span><span class="p">)])))</span><span class="w">
  </span><span class="p">(</span><span class="nf">dommy/listen!</span><span class="w"> </span><span class="p">(</span><span class="nf">dommy/sel1</span><span class="w"> </span><span class="no">:canvas</span><span class="p">)</span><span class="w"> </span><span class="no">:mousemove</span><span class="w">
                 </span><span class="o">#</span><span class="p">(</span><span class="nf">go</span><span class="w"> </span><span class="p">(</span><span class="nf">&gt;!</span><span class="w"> </span><span class="n">mouse-channel</span><span class="w"> </span><span class="p">[</span><span class="no">:move</span><span class="w"> </span><span class="p">(</span><span class="nf">.-clientX</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">.-clientY</span><span class="w"> </span><span class="n">%</span><span class="p">)])))</span><span class="w">
  </span><span class="p">(</span><span class="nf">dommy/listen!</span><span class="w"> </span><span class="n">js/window</span><span class="w"> </span><span class="no">:resize</span><span class="w">
                 </span><span class="o">#</span><span class="p">(</span><span class="nf">go</span><span class="w"> </span><span class="p">(</span><span class="nf">&gt;!</span><span class="w"> </span><span class="n">state-channel</span><span class="w"> </span><span class="no">:resize</span><span class="p">)))</span><span class="w">
  </span><span class="s">"Create new game"</span><span class="w">
  </span><span class="p">(</span><span class="nf">resize</span><span class="w"> </span><span class="p">{</span><span class="no">:dragging</span><span class="w"> </span><span class="n">false</span><span class="w">
           </span><span class="no">:time</span><span class="w"> </span><span class="mi">0</span><span class="w">
           </span><span class="no">:spawn-every</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">60</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w">
           </span><span class="no">:x-tiles</span><span class="w"> </span><span class="mi">16</span><span class="w">
           </span><span class="no">:y-tiles</span><span class="w"> </span><span class="mi">12</span><span class="w">
           </span><span class="no">:mouse-down</span><span class="w"> </span><span class="n">false</span><span class="w">
           </span><span class="no">:ball-size</span><span class="w"> </span><span class="mf">0.5</span><span class="w">
           </span><span class="no">:foot-size</span><span class="w"> </span><span class="mf">0.3</span><span class="w">
           </span><span class="no">:balls</span><span class="w"> </span><span class="p">[]</span><span class="w">
           </span><span class="no">:foot</span><span class="w"> </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="no">:y</span><span class="w"> </span><span class="mi">6</span><span class="p">}}))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">tick-the-clock</span><span class="w">
  </span><span class="s">"Send an 'time for a new frame' message to the time channel"</span><span class="w">
  </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="nf">go</span><span class="w"> </span><span class="p">(</span><span class="nf">&gt;!</span><span class="w"> </span><span class="n">time-channel</span><span class="w"> </span><span class="p">[</span><span class="no">:tick</span><span class="p">])))</span><span class="w">

</span><span class="s">"Run the game"</span><span class="w">
</span><span class="p">(</span><span class="nf">go-loop</span><span class="w"> </span><span class="p">[</span><span class="n">game</span><span class="w"> </span><span class="p">(</span><span class="nf">init</span><span class="p">)]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[[</span><span class="n">value</span><span class="w"> </span><span class="n">ch</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nf">alts!</span><span class="w"> </span><span class="p">[</span><span class="n">mouse-channel</span><span class="w"> </span><span class="n">time-channel</span><span class="w"> </span><span class="n">state-channel</span><span class="w"> </span><span class="n">action-channel</span><span class="p">])]</span><span class="w">
    </span><span class="p">(</span><span class="k">cond</span><span class="w">
      </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">time-channel</span><span class="w"> </span><span class="n">ch</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nf">do</span><span class="w">
        </span><span class="p">(</span><span class="nf">.requestAnimationFrame</span><span class="w"> </span><span class="n">js/window</span><span class="w"> </span><span class="n">tick-the-clock</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nf">game/draw</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nf">recur</span><span class="w"> </span><span class="p">(</span><span class="nf">game/time-tick</span><span class="w"> </span><span class="n">game</span><span class="p">)))</span><span class="w">
      
      </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">state-channel</span><span class="w"> </span><span class="n">ch</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="k">cond</span><span class="w">
        </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="no">:resize</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nf">recur</span><span class="w"> </span><span class="p">(</span><span class="nf">resize</span><span class="w"> </span><span class="n">game</span><span class="p">)))</span><span class="w">

      </span><span class="no">:default</span><span class="w">
      </span><span class="p">(</span><span class="nf">recur</span><span class="w"> </span><span class="p">(</span><span class="nf">game/action</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="n">game</span><span class="p">)))))</span><span class="w">

</span><span class="s">"Start the first frame"</span><span class="w">
</span><span class="p">(</span><span class="nf">tick-the-clock</span><span class="p">)</span><span class="w">

</span></code></pre>
</div>

<p>And</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="w">
</span><span class="c1">;; =====
;; FILE game.cljs
;; =====
</span><span class="w">
</span><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="n">kicker.game</span><span class="w">
  </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">[</span><span class="n">cljs.core.async</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">chan</span><span class="w"> </span><span class="n">&lt;!</span><span class="w"> </span><span class="n">&gt;!</span><span class="p">]]</span><span class="w">
            </span><span class="p">[</span><span class="n">dommy.core</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">dommy</span><span class="p">])</span><span class="w">
  </span><span class="p">(</span><span class="no">:require-macros</span><span class="w"> </span><span class="p">[</span><span class="n">cljs.core.async.macros</span><span class="w"> </span><span class="no">:refer</span><span class="w"> </span><span class="p">[</span><span class="n">go</span><span class="p">]]))</span><span class="w">

</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">state-channel</span><span class="w"> </span><span class="p">(</span><span class="nf">as/chan</span><span class="p">))</span><span class="w">
</span><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">action-channel</span><span class="w"> </span><span class="p">(</span><span class="nf">as/chan</span><span class="w"> </span><span class="mi">5</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="nf">defonce</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="mf">9.81</span><span class="p">)</span><span class="w">
</span><span class="p">(</span><span class="nf">defonce</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">60</span><span class="p">))</span><span class="w"> </span><span class="c1">; trusting the browser to run us at aproximately 60fps
</span><span class="w">
</span><span class="c1">;;-------------------------------------------------------------------------------------------
;; Physics and mathematics stuff
</span><span class="w">
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">dist</span><span class="w">
  </span><span class="s">"Measure euclidian distance between elements a and b"</span><span class="w">
  </span><span class="p">[</span><span class="n">a</span><span class="w"> </span><span class="n">b</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">dx</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="no">:x</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="no">:x</span><span class="w"> </span><span class="n">b</span><span class="p">))</span><span class="w">
        </span><span class="n">dy</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="no">:y</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="no">:y</span><span class="w"> </span><span class="n">b</span><span class="p">))]</span><span class="w">
    </span><span class="p">(</span><span class="nf">Math/sqrt</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">dx</span><span class="w"> </span><span class="n">dx</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">dy</span><span class="w"> </span><span class="n">dy</span><span class="p">)))))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">apply-gravity</span><span class="w">
  </span><span class="s">"Add gravity acceleration to y-speed"</span><span class="w">
  </span><span class="p">[</span><span class="n">ball</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="n">ball</span><span class="w"> </span><span class="no">:vy</span><span class="w"> </span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">g</span><span class="w"> </span><span class="n">dt</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">update-pos</span><span class="w">
  </span><span class="s">"Apply speed vectors to ball"</span><span class="w">
  </span><span class="p">[</span><span class="n">ball</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="n">ball</span><span class="w"> </span><span class="no">:x</span><span class="w"> </span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="p">(</span><span class="no">:vx</span><span class="w"> </span><span class="n">ball</span><span class="p">)))</span><span class="w">
      </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="no">:y</span><span class="w"> </span><span class="nb">+</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="p">(</span><span class="no">:vy</span><span class="w"> </span><span class="n">ball</span><span class="p">)))))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">collision</span><span class="w">
  </span><span class="s">"When ball is in range of our foot, set its speed to the position
  difference vector"</span><span class="w">
  </span><span class="p">[{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">ball-size</span><span class="w"> </span><span class="n">foot-size</span><span class="w"> </span><span class="n">foot</span><span class="p">]}</span><span class="w"> </span><span class="n">ball</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">pos?</span><span class="w"> </span><span class="p">(</span><span class="no">:vy</span><span class="w"> </span><span class="n">ball</span><span class="p">))</span><span class="w">
    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">min-dist</span><span class="w"> </span><span class="p">(</span><span class="nb">+</span><span class="w"> </span><span class="n">ball-size</span><span class="w"> </span><span class="n">foot-size</span><span class="p">)</span><span class="w">
          </span><span class="n">cur-dist</span><span class="w"> </span><span class="p">(</span><span class="nf">dist</span><span class="w"> </span><span class="n">foot</span><span class="w"> </span><span class="n">ball</span><span class="p">)]</span><span class="w">
      </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">cur-dist</span><span class="w"> </span><span class="n">min-dist</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">dx</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="no">:x</span><span class="w"> </span><span class="n">ball</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="no">:x</span><span class="w"> </span><span class="n">foot</span><span class="p">))</span><span class="w">
              </span><span class="n">dy</span><span class="w"> </span><span class="p">(</span><span class="nb">-</span><span class="w"> </span><span class="p">(</span><span class="no">:y</span><span class="w"> </span><span class="n">ball</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="no">:y</span><span class="w"> </span><span class="n">foot</span><span class="p">))]</span><span class="w">
          </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">ball</span><span class="w"> </span><span class="no">:vx</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="n">dx</span><span class="p">)</span><span class="w"> </span><span class="no">:vy</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">20</span><span class="w"> </span><span class="n">dy</span><span class="p">)))</span><span class="w">
        </span><span class="n">ball</span><span class="p">))</span><span class="w">
    </span><span class="n">ball</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">on-screen?</span><span class="w">
  </span><span class="s">"Is the ball still visible"</span><span class="w">
  </span><span class="p">[{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">x-tiles</span><span class="w"> </span><span class="n">y-tiles</span><span class="p">]</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">game</span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">]}]</span><span class="w">
  </span><span class="p">(</span><span class="nb">every?</span><span class="w"> </span><span class="nb">true?</span><span class="w"> </span><span class="p">[(</span><span class="nb">&lt;</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w">
                 </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">inc</span><span class="w"> </span><span class="n">x-tiles</span><span class="p">))</span><span class="w">
                 </span><span class="c1">;(&lt; -1 y)
</span><span class="w">                 </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="nb">inc</span><span class="w"> </span><span class="n">y-tiles</span><span class="p">))]))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">time-tick</span><span class="w">
  </span><span class="s">"Advance the game one frame"</span><span class="w">
  </span><span class="p">[{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">game</span><span class="p">}]</span><span class="w">
  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">zero?</span><span class="w"> </span><span class="p">(</span><span class="nf">mod</span><span class="w"> </span><span class="p">(</span><span class="no">:time</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="no">:spawn-every</span><span class="w"> </span><span class="n">game</span><span class="p">)))</span><span class="w">
    </span><span class="p">(</span><span class="nf">go</span><span class="w"> </span><span class="p">(</span><span class="nf">&gt;!</span><span class="w"> </span><span class="n">action-channel</span><span class="w"> </span><span class="p">[</span><span class="no">:add-ball</span><span class="p">])))</span><span class="w">
  </span><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="no">:time</span><span class="w"> </span><span class="nb">inc</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="no">:balls</span><span class="w">
             </span><span class="p">(</span><span class="nb">filter</span><span class="w"> </span><span class="p">(</span><span class="nb">partial</span><span class="w"> </span><span class="n">on-screen?</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w">
                     </span><span class="p">(</span><span class="nb">map</span><span class="w">          </span><span class="c1">; chain: gravity + detect collision + move
</span><span class="w">                      </span><span class="p">(</span><span class="nb">comp</span><span class="w"> </span><span class="p">(</span><span class="nb">partial</span><span class="w"> </span><span class="n">collision</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="n">update-pos</span><span class="w"> </span><span class="n">apply-gravity</span><span class="p">)</span><span class="w">
                      </span><span class="p">(</span><span class="no">:balls</span><span class="w"> </span><span class="n">game</span><span class="p">))))</span><span class="w">
      </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="no">:last-frame</span><span class="w"> </span><span class="n">kicker.core/timestamp</span><span class="p">)))</span><span class="w">

</span><span class="c1">;;-------------------------------------------------------------------------------------------
;; Coordinate transformation functions
</span><span class="w">
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">to-screen</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">x-tiles</span><span class="w"> </span><span class="n">y-tiles</span><span class="p">]}]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">width</span><span class="w"> </span><span class="p">(</span><span class="nf">.-innerWidth</span><span class="w"> </span><span class="n">js/window</span><span class="p">)</span><span class="w">
        </span><span class="n">height</span><span class="w"> </span><span class="p">(</span><span class="nf">.-innerHeight</span><span class="w"> </span><span class="n">js/window</span><span class="p">)</span><span class="w">
        </span><span class="n">sx</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="n">x-tiles</span><span class="p">))</span><span class="w">
        </span><span class="n">sy</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="n">y-tiles</span><span class="p">))]</span><span class="w">
    </span><span class="p">[</span><span class="n">sx</span><span class="w"> </span><span class="n">sy</span><span class="p">]))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">to-game</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">x-tiles</span><span class="w"> </span><span class="n">y-tiles</span><span class="p">]}]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">width</span><span class="w"> </span><span class="p">(</span><span class="nf">.-innerWidth</span><span class="w"> </span><span class="n">js/window</span><span class="p">)</span><span class="w">
        </span><span class="n">height</span><span class="w"> </span><span class="p">(</span><span class="nf">.-innerHeight</span><span class="w"> </span><span class="n">js/window</span><span class="p">)</span><span class="w">
        </span><span class="n">gx</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">x-tiles</span><span class="w"> </span><span class="n">width</span><span class="p">))</span><span class="w">
        </span><span class="n">gy</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="n">y-tiles</span><span class="w"> </span><span class="n">height</span><span class="p">))]</span><span class="w">
    </span><span class="p">[</span><span class="n">gx</span><span class="w"> </span><span class="n">gy</span><span class="p">]))</span><span class="w">

</span><span class="c1">;;-------------------------------------------------------------------------------------------
;; Action event handlers
</span><span class="w">
</span><span class="p">(</span><span class="k">defmulti</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="nb">first</span><span class="p">)</span><span class="w">

</span><span class="p">(</span><span class="k">defmethod</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="no">:startdrag</span><span class="w"> </span><span class="p">[[</span><span class="n">_</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="n">game</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">action</span><span class="w"> </span><span class="p">[</span><span class="no">:drag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="no">:dragging</span><span class="w"> </span><span class="n">true</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">defmethod</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="no">:enddrag</span><span class="w"> </span><span class="p">[</span><span class="n">_</span><span class="w"> </span><span class="n">game</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="no">:dragging</span><span class="w"> </span><span class="n">false</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">defmethod</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="no">:move</span><span class="w"> </span><span class="p">[[</span><span class="n">_</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="n">game</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="no">:dragging</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">action</span><span class="w"> </span><span class="p">[</span><span class="no">:drag</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w">
    </span><span class="n">game</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">defmethod</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="no">:drag</span><span class="w">
  </span><span class="c1">;; move foot to mouse position
</span><span class="w">  </span><span class="p">[[</span><span class="n">_</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="n">game</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[[</span><span class="n">nx</span><span class="w"> </span><span class="n">ny</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nf">to-game</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="n">game</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="no">:foot</span><span class="w"> </span><span class="p">(</span><span class="nb">assoc</span><span class="w"> </span><span class="p">(</span><span class="no">:foot</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="no">:x</span><span class="w"> </span><span class="n">nx</span><span class="w"> </span><span class="no">:y</span><span class="w"> </span><span class="n">ny</span><span class="p">))))</span><span class="w">

</span><span class="p">(</span><span class="k">defmethod</span><span class="w"> </span><span class="n">action</span><span class="w"> </span><span class="no">:add-ball</span><span class="w">
  </span><span class="c1">;; spawn a new ball at random position
</span><span class="w">  </span><span class="p">[</span><span class="n">v</span><span class="w"> </span><span class="n">game</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">update</span><span class="w"> </span><span class="n">game</span><span class="w"> </span><span class="no">:balls</span><span class="w"> </span><span class="nb">conj</span><span class="w"> </span><span class="p">{</span><span class="no">:x</span><span class="w"> </span><span class="p">(</span><span class="nb">rand</span><span class="w"> </span><span class="p">(</span><span class="no">:x-tiles</span><span class="w"> </span><span class="n">game</span><span class="p">))</span><span class="w">
                            </span><span class="no">:y</span><span class="w"> </span><span class="mi">-1</span><span class="w">
                            </span><span class="no">:vx</span><span class="w"> </span><span class="mi">0</span><span class="w">
                            </span><span class="no">:vy</span><span class="w"> </span><span class="mi">0</span><span class="p">}))</span><span class="w">

</span><span class="c1">;;-------------------------------------------------------------------------------------------
;; Drawing function
</span><span class="w">
</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">draw</span><span class="w">
  </span><span class="p">[{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">s</span><span class="w"> </span><span class="n">x-tiles</span><span class="w"> </span><span class="n">y-tiles</span><span class="w"> </span><span class="n">foot</span><span class="w"> </span><span class="n">balls</span><span class="p">]</span><span class="w"> </span><span class="no">:as</span><span class="w"> </span><span class="n">game</span><span class="p">}]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">ctx</span><span class="w"> </span><span class="p">(</span><span class="nf">.getContext</span><span class="w"> </span><span class="p">(</span><span class="nf">dommy/sel1</span><span class="w"> </span><span class="no">:canvas</span><span class="p">)</span><span class="w"> </span><span class="s">"2d"</span><span class="p">)</span><span class="w">
        </span><span class="p">[</span><span class="n">foot-x</span><span class="w"> </span><span class="n">foot-y</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nf">to-screen</span><span class="w"> </span><span class="p">(</span><span class="no">:x</span><span class="w"> </span><span class="n">foot</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="no">:y</span><span class="w"> </span><span class="n">foot</span><span class="p">)</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w">
        </span><span class="n">ball-size</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="no">:ball-size</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w">
        </span><span class="n">foot-size</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="p">(</span><span class="no">:foot-size</span><span class="w"> </span><span class="n">game</span><span class="p">)</span><span class="w"> </span><span class="n">s</span><span class="p">)]</span><span class="w">
    </span><span class="p">(</span><span class="nf">set!</span><span class="w"> </span><span class="p">(</span><span class="nf">.-fillStyle</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="s">"#AAAAFF"</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">.fillRect</span><span class="w"> </span><span class="n">ctx</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nf">.-innerWidth</span><span class="w"> </span><span class="n">js/window</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">.-innerHeight</span><span class="w"> </span><span class="n">js/window</span><span class="p">))</span><span class="w">
    
    </span><span class="p">(</span><span class="nf">set!</span><span class="w"> </span><span class="p">(</span><span class="nf">.-fillStyle</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="s">"#000000"</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nb">doto</span><span class="w"> </span><span class="n">ctx</span><span class="w">
      </span><span class="p">(</span><span class="nf">.beginPath</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nf">.arc</span><span class="w"> </span><span class="p">(</span><span class="nb">int</span><span class="w"> </span><span class="n">foot-x</span><span class="p">)</span><span class="w">
            </span><span class="p">(</span><span class="nb">int</span><span class="w"> </span><span class="n">foot-y</span><span class="p">)</span><span class="w">
            </span><span class="n">foot-size</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">Math/PI</span><span class="p">))</span><span class="w">
      </span><span class="p">(</span><span class="nf">.fill</span><span class="p">))</span><span class="w">
    
    </span><span class="p">(</span><span class="nf">set!</span><span class="w"> </span><span class="p">(</span><span class="nf">.-fillStyle</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="s">"#FFFFFF"</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">ball</span><span class="w"> </span><span class="n">balls</span><span class="p">]</span><span class="w">
      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[[</span><span class="n">x</span><span class="w"> </span><span class="n">y</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nf">to-screen</span><span class="w"> </span><span class="p">(</span><span class="no">:x</span><span class="w"> </span><span class="n">ball</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="no">:y</span><span class="w"> </span><span class="n">ball</span><span class="p">)</span><span class="w"> </span><span class="n">game</span><span class="p">)]</span><span class="w">
        </span><span class="p">(</span><span class="nb">doto</span><span class="w"> </span><span class="n">ctx</span><span class="w">
          </span><span class="p">(</span><span class="nf">.beginPath</span><span class="p">)</span><span class="w">
          </span><span class="p">(</span><span class="nf">.arc</span><span class="w"> </span><span class="p">(</span><span class="nb">int</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nb">int</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="n">ball-size</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">(</span><span class="nb">*</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">Math/PI</span><span class="p">))</span><span class="w">
          </span><span class="p">(</span><span class="nf">.fill</span><span class="p">))))))</span><span class="w">
</span></code></pre>
</div>

<h2 id="summary">Summary</h2>

<p>We now have balls dropping from the sky and round player thingie that kicks them
around. Everything works as expected (though the collission may look weird when
not running in a perfectly square canvas), and it’s even semi-fun to play it for
a minute or so.</p>

<p>In the next article we’ll begin to use that vacant <code class="highlighter-rouge">state-channel</code> you might
have noticed. It will allow us to manage asset loading and keeping track of the
game progress.</p>

                

              </div>
              
              <div id="disqus_thread">
                <script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    
    var disqus_config = function () {
        this.page.url = "https://hermann-p.github.io/";  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = /2016/06/functional-games-1_5; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    
    (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document, s = d.createElement('script');
        
        s.src = '//waechtertroll.disqus.com/embed.js';  // IMPORTANT: Replace EXAMPLE with your forum shortname!
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
              </div>
              
            </div>
          </div>
        </div>
        <div class="col-md-4 hidden-xs">
          <div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li><a href="/2016/06/functional-games-1_5">Functional game programming with core.async part 1.5</a></li>
    
    <li><a href="/2016/05/functional-games-1">Functional game programming with core.async</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Tags</h2>
  <ul>
    
      <li><a href="/tag/games">games</a></li>
    
      <li><a href="/tag/functional">functional</a></li>
    
      <li><a href="/tag/async">async</a></li>
    
  </ul>
</div>

        </div>
      </div>
    </div>
    
<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'waechtertroll'; // required: replace example with your forum shortname
  var disqus_identifier = "/2016/06/functional-games-1_5";

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  </div>
      <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <!-- <p>Pavel Makhov &copy; 2015</p> -->
          <h6>Follow me</h6>

<ul class="social-media">

  
    <li>
      <a title="hermann-p on Github" href="https://github.com/hermann-p" target="_blank"><i class="fa fa-github fa-2x"></i></a>
    </li>
  

  
    <li>
      <a title="waechtertroll on StackOverflow" href="http://stackoverflow.com/users/waechtertroll" target="_blank"><i class="fa fa-stack-overflow fa-2x"></i></a>
    </li>
  

  

  

  

  
    <li>
      <a title="feed.xml RSS" href="/feed.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </li>
  

</ul>

        </div>
      </div>
    </footer>
  </body>
</html>

</div>
